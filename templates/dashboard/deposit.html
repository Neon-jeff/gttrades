{% extends "dbase.html" %}
{%load static%}

{% block content %}

<section class="bg-black  text-white max-md:pt-24" x-data="assets">
{{ wallets|json_script:"wallets"}}
{% include "components/sidenav.html" %}
{% include "components/loader.html" %}
{% include "components/error.html" %}
{% include "components/alerts.html" %}

{% comment %} main content {% endcomment %}
<div class="ml-72 max-md:ml-0 p-5 ">
<div class='max-md:hidden'>
{% include "components/path.html" %}
</div>


<!-- Currency toggle list -->

<div >
    <h1 class='text-2xl font-medium pb-4'>Deposits</h1>
    <!-- main container -->
    <div class="bg-sub p-10 max-md:p-3 rounded-md  flex justify-center">

        <form action="" class="flex flex-col gap-5 w-4/5 max-md:w-full" @submit="submitForm">
            {% csrf_token %}
                   <p class="text-sm text-gray-400 font-medium flex items-center gap-3 max-md:flex-col max-md:items-start"><ion-icon name="alert-circle-outline" class="text-2xl text-green-500"></ion-icon>Fund your trading account by paying your choice of cryptocurrency and upload corresponding payment proof</p>
            <fieldset class="flex flex-col gap-2">
                <label for="">Select Currency:</label>
                <!-- default select tab -->
                <div class="w-full" @click="show=!show">
                <span  class='p-3 cursor-pointer bg-black rounded-md text-xs flex items-center justify-between gap-2 w-full '>
                <span class='flex items-center gap-5'>
                                    <img :src="currentCoin.image" alt="" class='h-[30px] w-[30]'>
                 <span class='' x-text="currentCoin.name"></span>
                </span>
                <ion-icon name="chevron-down-outline"  class='text-lg'></ion-icon>
            </span>
                </div>

                                <div class=' bottom-0 w-full bg-gray-700 flex flex-col  p-5 rounded-md '  x-show="show" x-transition x-transition.duration.500ms>


            <template x-for="asset in coins" :key="asset.name" >
                                <div class='cursor-pointer bg-gray-700 rounded-md hover:bg-black py-3 hover:px-3 transition duration-500  ease-in justify-between font-medium text-sm flex items-center gap-2' @click="setCurrentCoin(asset.name)">
            <div class='flex items-center gap-4' ><img src="" :src="asset.image" alt="" class='h-[30px] w-[30px]'>
                <span x-text="asset.name"></span>

            </template>


            </div>
            </fieldset>

            <fieldset class="flex flex-col gap-2">
                <label for="">Address:</label>
                <span class="w-full bg-black flex justify-between items-center p-3 rounded-md">
                    <input type="text" :value="currentCoin.address" class="bg-black p-2 addr w-full text-sm text-main  rounded-md" disabled>
                    <ion-icon name="copy-outline" :class="copied?'cursor-pointer text-xl p-2 rounded-md bg-sub text-green-500':'cursor-pointer text-xl p-2 rounded-md bg-sub'" @click="copytoClipboard"></ion-icon>
                </span>

            </fieldset>

                        <fieldset class="flex flex-col gap-2">
                <label for="">Amount(USD):</label>
                <input type="number" :value="currentCoin.address" name="amount" class="bg-black p-5 text-sm  rounded-md" placeholder="Enter amount" required>

            </fieldset>
            <h1>Payment Proof:</h1>
            <fieldset class="flex flex-col gap-5 border-[1px] items-center text-xs  border-gray-600 p-5 rounded-md">
                <label for="proof" class="flex flex-col items-center text-xs gap-1 cursor-pointer">
                    <ion-icon name="cloud-upload-outline" class="text-2xl pb-2"></ion-icon>
                    <span class="font-semibold text-main text-sm">Click to upload</span>
                    <span>(PNG,JPG)</span>
                </label>
                <input type="file" accept="image/*" id="proof" class="bg-black p-3 text-sm text-main  rounded-md" hidden @change="handleFileChange" name="image" >
                <span class="flex items-center gap-5 bg-black p-2 rounded-md" x-show="upload">
                    <ion-icon name="image-outline" class="text-3xl text-green-500"></ion-icon>
                    <span x-text="fileName"></span>
                </span>
            </fieldset>
        <button  class='bg-main p-3 rounded-md'>
            Deposit
        </button>
        </form>
    </div>
</div>

<!-- deposit history -->

<div class="p-5 rounded-md w-full mt-10 bg-sub">
    <h1>Deposit History</h1>
    <div class="flex flex-col gap-5  items-center mt-8 ">
    {% for deposit in deposits  %}

        <div class="bg-black p-5 rounded-md flex justify-between items-center text-sm w-full">
        <p>${{deposit.amount}}</p>
        <p>{{deposit.currency}}</p>
        <p>{{deposit.created}}</p>
        {% if deposit.confirmed %}
        <ion-icon name="checkmark-circle" class="text-green-500 text-2xl"></ion-icon>
        {% else %}
        <ion-icon name="alert-circle" class="text-orange-500 text-2xl"></ion-icon>
        {% endif %}

    </div>

    {% endfor %}
    </div>

</div>

</div>
<script src="{% static 'js/fetch-data.js'%}"></script>

<script>
    document.addEventListener('alpine:init', () => {
        let form=new FormData(document.querySelector('form'))
        const assets = JSON.parse(document.getElementById("wallets").textContent);
        Alpine.data('assets', () => ({
            coins: assets,
            currentCoin:assets[0],
            setCurrentCoin(name){
                this.currentCoin=this.coins.find(item=>item.name==name)
                this.show=false
            },
            show:false,
            upload:false,
            fileName:'',
            copied:false,
            handleFileChange(e){
                this.fileName=e.target.files[0].name
                this.upload=true
            },
            async copytoClipboard(){
                let input=document.querySelector('.addr')
                try {
                    await navigator.clipboard.writeText(input.value);
                    console.log('Content copied to clipboard');
                }
                catch (err) {
                    console.error('Failed to copy: ', err);
                }
                await setTimeout(()=>{
                    this.copied=false
                },3000)
                this.copied=true
            },
            // MAKE DEPOSIT WITH THIS FUNCTION
            async submitForm(e){
                e.preventDefault()
                if(e.target.image.files.length==0){
                    this.errorMessage="Upload Payment Proof"
                    this.showError=true
                    console.log("nothing");
                    return
                }
                form.set('amount',e.target.amount.value)
                form.set('image',e.target.image.files[0])
                form.set('currency',this.currentCoin.name)
                this.showLoader=true
                await fetch('',{
                    body:form,
                    method:'post',
                }).then(async (res)=>{
                    let data=await res.json()
                    if (res.status==200){
                        await window.location.reload()

                    }
                })

            },
            showLoader:false,
            showError:false,
            errorMessage:"Something went wrong",
        }))
    })
</script>
</section>

{% endblock content %}

